
### **施工工序设计方案**

施工工序是一个灵活多变的流程，不同项目可能有不同的施工顺序，同时需要保证施工负责人能够及时收到通知。为了满足这些需求，我们采用 **事件驱动+灵活编排** 的方式进行设计，而非严格的工作流。

---

## **1. 施工工序数据模型设计**

### **核心表设计**

|表名|说明|
|---|---|
|`construction_task`|施工任务表，每个项目的施工工序实例|
|`construction_step`|施工工序定义表（模板）|
|`construction_assignee`|施工人员与任务的关联表|
|`construction_notify_log`|施工通知日志表|

---

### **`construction_step` (施工工序模板)**

> 定义可选施工步骤，设置默认前置依赖关系（可调整）

|字段|类型|说明|
|---|---|---|
|id|BIGINT|工序ID|
|step_name|VARCHAR(100)|工序名称（如 "水泥砂浆进场"）|
|step_type|ENUM|施工类别（硬装/软装/水电等）|
|default_prev_steps|JSON|默认前置步骤（可选）|
|can_skip|BOOLEAN|是否允许跳过|
|estimated_days|INT|预计工期|

---

### **`construction_task` (施工任务)**

> 每个项目实例化工序，动态调整

|字段|类型|说明|
|---|---|---|
|id|BIGINT|任务ID|
|project_id|BIGINT|施工项目ID|
|step_id|BIGINT|施工工序ID（引用 `construction_step.id`）|
|status|ENUM|施工状态（待开始/进行中/完成/跳过）|
|assigned_user_id|BIGINT|施工负责人|
|prev_steps|JSON|实际前置工序（可调整）|
|start_time|DATETIME|开始时间|
|end_time|DATETIME|完成时间|
|photos|JSON|施工照片上传路径|

---

### **`construction_assignee` (施工人员与任务)**

> 绑定施工人员，允许多人协作

|字段|类型|说明|
|---|---|---|
|id|BIGINT|记录ID|
|task_id|BIGINT|施工任务ID|
|user_id|BIGINT|施工负责人|
|role|ENUM|角色（施工员/监理/业主）|

---

### **`construction_notify_log` (施工通知日志)**

> 记录通知情况，确保微信通知已送达

|字段|类型|说明|
|---|---|---|
|id|BIGINT|记录ID|
|task_id|BIGINT|施工任务ID|
|user_id|BIGINT|被通知人|
|notify_time|DATETIME|通知时间|
|status|ENUM|状态（已发送/失败/已确认）|

---

## **2. 施工工序执行流程**

### **(1) 任务创建**

- 施工方案确定后，系统根据施工类型（硬装、软装等）生成 `construction_task` 任务列表，并初始化 `status=待开始`。
- 允许项目经理调整 **工序顺序**，跳过非必要工序。

---

### **(2) 任务执行**

#### **条件触发模式**

- 某个工序 `status=完成` 时：
    - 查询 `construction_task`，找到所有 **以该工序为前置任务** 的工序。
    - 如果前置工序都已完成，则将该工序 `status=待开始` 并 **发送通知**。

---

### **(3) 微信通知**

**触发通知逻辑**

- 任务 `status=待开始`，系统调用 **微信公众号模板消息接口** 发送消息：
    - 施工负责人接到任务通知
    - 任务详情、预计工期、上一环节负责人信息
    - 附带小程序/链接，可查看施工内容

**通知示例**

> 【施工任务提醒】  
> 任务：墙面找平  
> 负责人：张三  
> 前置任务：水泥砂浆进场（已完成）  
> 预计工期：2天  
> [点击查看详情](https://mp.weixin.qq.com/xxx)

---

### **(4) 任务完成**

- 施工人员在 **微信公众号/小程序** 中上传施工照片，并标记 `status=完成`。
- 触发 **后续工序解锁**，如 "墙面找平" 完成后，"上墙涂料" 变为 `待开始`。

---

### **(5) 施工验收**

- 监理或业主可查看 **已完成任务**，确认 `施工质量`：
    - 若合格，直接 `status=已验收`。
    - 若不合格，退回施工员 `status=返工`。

---

## **3. 施工流程示例**

以 **硬装施工流程** 为例：

1. **水泥砂浆进场** → `status=完成`
2. **墙面找平** → `待开始`（负责人收到微信通知）
3. **上墙涂料** → `待开始`（等待墙面找平完成）
4. **地板安装** → `待开始`（等待涂料完成）

---

## **4. 关键设计点**

### **(1) 灵活的工序依赖**

- `default_prev_steps` 仅为建议顺序，实际工序依赖可调整。

### **(2) 高并发处理**

- 采用 `RocketMQ` 进行任务状态更新：
    - 施工完成 -> **消息通知后续任务**
    - 施工负责人变更 -> **通知最新负责人**

### **(3) 大量图片存储优化**

- 施工照片存储在 `MinIO`，支持 **压缩存储**，前端采用 **CDN 加速**。

---

## **总结**

1. **去工作流化**：工序依赖关系可调整，任务动态创建，支持施工过程灵活变化。
2. **事件驱动**：基于 `RocketMQ` 触发后续任务，提高任务解锁效率。
3. **微信通知集成**：通过 **微信公众号模板消息** 进行实时提醒。
4. **施工人员管理**：支持多人施工、监理验收，并可灵活调整负责人。
5. **BIM & 照片存档**：结合 `MinIO` 进行模型、照片管理，提高施工可视化。

这样，整个施工流程既能保证 **通知及时性**，又能适应 **施工现场实际情况的变化**！🚀